<template>
  <v-container
    align-baseline="true"
    class="container">
    <v-row class="mx-2">
      <h2>리뷰 작성</h2>
    </v-row>
    <v-row class="mx-2">
      <v-col cols="8">
        <v-text-field
          label="제목"
          v-model="title"
          :color="this.$store.state.color"
        />
      </v-col>
    </v-row>
    <v-row class="mx-2" align="center">
      <v-col cols="4">
        <v-text-field
          label="모델명"
          v-model="model"
          :color="this.$store.state.color"
        />
      </v-col>
      <v-col cols="4">
        <v-select
          :items="categoryList"
          v-model="category"
          label="카테고리"
          class="input-group--focused"
          item-text="name"
        ></v-select>
      </v-col>
    </v-row>
    <v-row class="mx-2" align="center">
      <v-col cols="4">
        <v-layout row wrap>
        <v-menu
          lazy
          :close-on-content-click="false"
          v-model="menu"
          transition="scale-transition"
          offset-y
          full-width
          :nudge-right="40"
          max-width="290px"
          min-width="290px"
        >
          <template v-slot:activator="{ on }">
            <v-text-field
              label="사용 날짜"
              prepend-icon="event"
              readonly
              :value="useDate"
              v-on="on"
              color="rgb(203, 203, 77)"
            ></v-text-field>
          </template>
          <v-date-picker
            v-model="useDate"
            no-title
            color="rgb(203, 203, 77)"
            @input="menu = false"
            scrollable></v-date-picker>
        </v-menu>
        </v-layout>
      </v-col>
      <v-col cols="4">
        <v-rating
          v-model="rating"
          :background-color="this.$store.state.color"
          size="40"
          :color="this.$store.state.color"
        ></v-rating>
      </v-col>
    </v-row>
    <v-row class="mx-2" align="center">
      <v-col cols="8">
        <v-textarea
          label="리뷰 내용"
          :color="this.$store.state.color"
          outlined
          v-model="context"
        />
      </v-col>
    </v-row>
    <v-row class="mx-2" align="center">
      <v-col cols="8">
        <v-file-input
          multiple
          :color="this.$store.state.color"
          v-model="files"
          label="사진 업로드"
        >
        </v-file-input>
      </v-col>
    </v-row>
    <v-row>
      <v-spacer/>
      <v-col cols="5">
        <v-btn
          :color="this.$store.state.color"
          @click="writeReview">
          등록</v-btn>
      </v-col>
    </v-row>
  </v-container>
</template>

<script>
import axios from 'axios'
export default {
  name: 'WriteReview',
  data () {
    return {
      title: '',
      model: '',
      rating: 0,
      menu: false,
      useDate: new Date().toISOString().substr(0, 10),
      context: '',
      files: [],
      categoryList: [],
      category: ''
    }
  },
  mounted () {
    // Authorization token validating
    var token = this.$store.state.userToken
    axios
      .get('http://localhost:8080/user/' + this.$store.state.userId, {
        headers: {
          'Authorization': token
        }
      })
      .then(response => {
        // 카테고리 리스트 검색
        axios
          .get('http://localhost:8080/category', {
            headers: {
              'Authorization': token
            }
          })
          .then(response => {
            this.categoryList = response.data.data
            console.log(this.categoryList)
            console.log(this.items)
          })
      })
      .catch(() => {
        alert('로그인이 필요한 서비스입니다.')
        this.$store.state.userToken = ''
        this.$store.state.userId = ''
        this.$router.push('/user/login')
      })
  },
  methods: {
    writeReview () {
      if (this.files.length > 0) {
        var fileData = new FormData()
        for (var i = 0; i < this.files.length; i++) {
          fileData.append('files', this.files[i])
        }

        axios
          .post('http://localhost:8080/review/files', fileData, {
            headers: {
              'enctype': 'multipart/form-data'
            }
          })
          .then(response => {
            if (response.data.state === 'ok') {
              this.saveReview(response.data.data)
            } else {
              alert('파일 업로드에 실패했습니다.')
            }
          })
      }
    },
    saveReview (fileNames) {
      var reviewData = {
        'title': this.title,
        'writer': this.$store.state.userId,
        'model': this.model,
        'category': this.category,
        'regDate': new Date(),
        'useDate': this.useDate,
        'rating': this.rating,
        'context': this.context,
        'files': fileNames
      }

      axios
        .post('http://localhost:8080/review', reviewData)
        .then(response => {
          if (response.data.data === 'success') {
            alert('리뷰가 등록되었습니다.')
            this.$router.push('/')
          } else {
            alert('리뷰 등록에 실패했습니다.')
          }
        })
    }
  }
}
</script>

<style>
  .container {
    margin-top: 20px;
  }
</style>
